// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

model Product {
  id                    String   @id @default(cuid())
  upc                   String?  @unique
  ean                   String?
  gtin                  String?
  isbn                  String?  @unique
  mpn                   String?
  title                 String
  description           String?
  brand                 String?
  model                 String?
  color                 String?
  size                  String?
  dimensions            Json?
  weight                Float?
  quantity              Int      @default(0)
  currency              String   @default("USD")
  lowestRecordedPrice   Float?
  highestRecordedPrice  Float?
  lastScanned           DateTime?
  
  // Relations
  images                ProductImage[]
  offers                Offer[]
  categories            ProductCategory[]
  listings              Listing[]
  drafts                Draft[]
  aiContent             AIContent?
  
  // Legacy fields for compatibility
  name                  String?  // alias for title
  sku                   String?  @unique
  barcode               String?
  price                 Float?
  cost                  Float?
  category              String?
  condition             String?  // "new", "used", "refurbished"
  aiGeneratedContent    Json?
  metadata              Json?
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt

  @@map("products")
}

model ProductImage {
  id           String  @id @default(cuid())
  productId    String
  imageNumber  Int
  originalUrl  String
  uploadStatus String  @default("pending")
  url          String?
  altText      String?
  isPrimary    Boolean @default(false)
  product      Product @relation(fields: [productId], references: [id], onDelete: Cascade)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  @@map("product_images")
}

model Listing {
  id          String      @id @default(cuid())
  productId   String
  platform    String      // "ebay", "amazon", "mercari", etc.
  platformId  String?     // External platform listing ID
  title       String
  description String?
  price       Float
  quantity    Int         @default(1)
  status      ListingStatus @default(DRAFT)
  publishedAt DateTime?
  endDate     DateTime?
  views       Int         @default(0)
  watchers    Int         @default(0)
  product     Product     @relation(fields: [productId], references: [id], onDelete: Cascade)
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt

  @@map("listings")
}

model Draft {
  id          String    @id @default(cuid())
  productId   String?
  title       String?
  description String?
  price       Float?
  platform    String?   // Target platform
  templateData Json?     // CPI template data, eBay data, etc.
  notes       String?
  product     Product?  @relation(fields: [productId], references: [id], onDelete: SetNull)
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  @@map("drafts")
}

model ScanSession {
  id        String   @id @default(cuid())
  sessionId String   @unique
  data      Json?    // Temporary scan data
  status    String   @default("active") // "active", "completed", "expired"
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("scan_sessions")
}

enum ListingStatus {
  DRAFT
  ACTIVE
  SOLD
  ENDED
  CANCELLED
}

model Offer {
  id           String   @id @default(cuid())
  productId    String
  merchant     String?
  domain       String?
  title        String?
  price        Float?
  listPrice    Float?
  currency     String   @default("USD")
  shipping     String?
  condition    String?
  availability String?
  link         String?
  product      Product  @relation(fields: [productId], references: [id], onDelete: Cascade)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  @@map("offers")
}

model Category {
  id          String   @id @default(cuid())
  type        String   // "google", "ebay", etc.
  categoryId  String
  name        String
  fullPath    String?
  products    ProductCategory[]
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@unique([type, categoryId])
  @@map("categories")
}

model ProductCategory {
  id         String   @id @default(cuid())
  productId  String
  categoryId String
  isPrimary  Boolean  @default(false)
  product    Product  @relation(fields: [productId], references: [id], onDelete: Cascade)
  category   Category @relation(fields: [categoryId], references: [id], onDelete: Cascade)
  createdAt  DateTime @default(now())

  @@unique([productId, categoryId])
  @@map("product_categories")
}

model ApiLog {
  id           String    @id @default(cuid())
  service      String
  endpoint     String
  method       String
  statusCode   Int
  requestData  String?
  responseData String?
  errorMessage String?
  createdAt    DateTime  @default(now())

  @@map("api_logs")
}

model CategoryTemplate {
  id              String   @id @default(cuid())
  categoryKey     String   // e.g., 'funko_pops', 'womens_clothing'
  templateName    String   // e.g., 'Standard Funko', 'My Funko Defaults'
  templateData    Json     // Item specifics values
  isDefault       Boolean  @default(false)
  isSystemDefault Boolean  @default(false) // Built-in system templates
  userId          String?  // null for system templates
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@unique([categoryKey, templateName, userId])
  @@map("category_templates")
}

model UserPreference {
  id          String   @id @default(cuid())
  userId      String   // User identifier (could be session-based for now)
  categoryKey String   
  fieldName   String   // Item specific field name
  defaultValue String  // Default value for this field
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@unique([userId, categoryKey, fieldName])
  @@map("user_preferences")
}

model AIContent {
  id                    String   @id @default(cuid())
  productId             String   @unique
  seoTitle              String?
  seoDescription        String?
  productDescription    String?
  bulletPoints          String?  // JSON string
  tags                  String?  // JSON string
  category              String?
  specifications        String?  // JSON string
  marketingCopy         String?
  ebayTitle            String?
  shortDescription      String?
  uniqueSellingPoints   String?  // JSON string
  keyFeatures          String?  // JSON string
  specificationsArray   String?  // JSON string
  itemSpecifics        String?  // JSON string
  additionalAttributes String?  // JSON string
  status               String   @default("pending") // pending, processing, completed, failed
  aiModel              String?
  generatedAt          DateTime?
  processingTime       Int?
  product              Product  @relation(fields: [productId], references: [id], onDelete: Cascade)
  createdAt            DateTime @default(now())
  updatedAt            DateTime @updatedAt

  @@map("ai_content")
}
